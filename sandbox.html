<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meta-Mind | Sandbox v7.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use type="module" to load the local ES modules -->
    <script type="module">
        import { MetaMindKernel } from './meta-mind-core.js';
        import { TextPhaseEngine, WebPhaseEngine, PhaseRegistry } from './phase-engines.js';

        // Initialize Global Kernel
        window.MM = new MetaMindKernel();
        const Registry = new PhaseRegistry(window.MM);

        // Register Phases
        Registry.register(new TextPhaseEngine(window.MM));
        Registry.register(new WebPhaseEngine(window.MM));

        // --- UI CONTROLLER ---
        window.UI = {
            activePhase: 'map',
            isPanning: false,
            lastMouse: { x: 0, y: 0 },

            init() {
                // DOM Elements
                this.viewport = document.getElementById('viewport');
                this.world = document.getElementById('world-layer');
                this.svg = document.getElementById('edge-svg');
                this.nodeLayer = document.getElementById('node-layer');
                this.inspector = document.getElementById('inspector-content');

                // Bind Global Events
                this.bindEvents();

                // Initial Render
                if (MM.state.nodes.length > 0) {
                    document.getElementById('login-overlay').style.display = 'none';
                    this.render(MM.state);
                }

                // Subscribe to Kernel
                MM.subscribe((state, type) => this.render(state, type));
            },

            bindEvents() {
                // Login Form
                document.getElementById('login-form').onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('login-name').value;
                    const role = document.getElementById('login-role').value;

                    // Create Root Profile
                    const root = MM.addNode({ title: name, type: 'profile', position: { x: 0, y: 0 }, content: `Role: ${role}` });
                    const bio = MM.addNode({ title: 'Bio', type: 'section', position: { x: -200, y: 150 }, content: 'Enter bio here...' });
                    const social = MM.addNode({ title: 'Socials', type: 'widget', position: { x: 200, y: 150 }, content: 'Links...' });
                    MM.addEdge(root, bio);
                    MM.addEdge(root, social);

                    MM.autoLayout();
                    document.getElementById('login-overlay').style.display = 'none';
                };

                // Phase Switching (Top Widget)
                document.querySelectorAll('.phase-btn').forEach(btn => {
                    btn.onclick = () => {
                        this.activePhase = btn.dataset.phase;
                        // Update buttons
                        document.querySelectorAll('.phase-btn').forEach(b => b.className = "phase-btn px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-slate-50");
                        btn.className = "phase-btn px-3 py-1 text-xs font-bold rounded bg-slate-900 text-white";

                        // Update Views Visibility
                        document.querySelectorAll('.phase-view').forEach(v => {
                            v.style.display = 'none';
                            v.classList.remove('active');
                        });
                        const targetView = document.getElementById(`view-${this.activePhase}`);
                        if (targetView) {
                            targetView.style.display = 'block';
                            targetView.classList.add('active');
                        }

                        // Trigger render
                        this.render(MM.state);
                    };
                });

                // Pan/Zoom
                this.viewport.onmousedown = (e) => {
                    if (e.target === this.viewport || e.target === this.svg) {
                        this.isPanning = true;
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    }
                };
                window.onmousemove = (e) => {
                    if (this.isPanning) {
                        MM.pan(e.clientX - this.lastMouse.x, e.clientY - this.lastMouse.y);
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    }
                };
                window.onmouseup = () => this.isPanning = false;
                this.viewport.onwheel = (e) => {
                    e.preventDefault();
                    MM.zoom(e.deltaY > 0 ? -0.1 : 0.1, e.clientX, e.clientY);
                };

                // Add Node
                this.viewport.ondblclick = (e) => {
                    if (this.activePhase === 'map') {
                        const pos = MM.screenToWorld(e.clientX, e.clientY);
                        MM.addNode({ position: pos });
                        MM.autoLayout(); // Auto-arrange on creation
                    }
                };

                // Toolbar
                document.getElementById('btn-reset').onclick = () => MM.resetStorage();
                document.getElementById('btn-layout').onclick = () => MM.autoLayout();
            },

            render(state, type) {
                if (this.activePhase === 'map') {
                    this.renderMap(state);
                } else {
                    Registry.activeId = this.activePhase;
                    let targetId = this.activePhase === 'web' ? 'web-target' : 'text-target';
                    Registry.renderActive(targetId);
                }
                this.renderInspector(state);
            },

            renderMap(state) {
                // Apply Transform
                this.world.style.transform = `translate(${state.viewport.x}px, ${state.viewport.y}px) scale(${state.viewport.scale})`;

                // Render Nodes
                this.nodeLayer.innerHTML = '';
                state.nodes.forEach(n => {
                    const el = document.createElement('div');
                    el.className = `absolute w-16 h-16 bg-white border-2 rounded-full flex flex-col items-center justify-center transition-all duration-200 shadow-sm cursor-pointer z-20 hover:border-orange-400 ${state.selectedId === n.id ? 'border-orange-500 shadow-md scale-110' : 'border-slate-300'}`;
                    el.style.left = `${n.position.x}px`;
                    el.style.top = `${n.position.y}px`;
                    el.style.transform = 'translate(-50%, -50%)';
                    el.onclick = (e) => {
                        e.stopPropagation();
                        MM.state.selectedId = n.id;
                        MM.notify();
                    };
                    el.innerHTML = `<div class="text-[8px] font-bold uppercase text-slate-500 pointer-events-none truncate max-w-full px-1">${n.title}</div>`;
                    this.nodeLayer.appendChild(el);
                });

                // Render Edges (Unified World Layer)
                this.svg.innerHTML = '';
                state.edges.forEach(e => {
                    const s = state.nodes.find(n => n.id === e.source);
                    const t = state.nodes.find(n => n.id === e.target);
                    if (s && t) {
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        line.setAttribute("x1", s.position.x);
                        line.setAttribute("y1", s.position.y);
                        line.setAttribute("x2", t.position.x);
                        line.setAttribute("y2", t.position.y);
                        line.setAttribute("stroke", "#cbd5e1");
                        line.setAttribute("stroke-width", "2");
                        this.svg.appendChild(line);
                    }
                });
            },

            renderInspector(state) {
                const node = state.nodes.find(n => n.id === state.selectedId);
                if (!node) {
                    this.inspector.innerHTML = `<div class="text-center opacity-30 mt-10">Select a Node</div>`;
                    return;
                }

                // Only re-render if ID changed
                if (this.inspector.dataset.renderedId === node.id) return;
                this.inspector.dataset.renderedId = node.id;

                this.inspector.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Title</label>
                            <input id="insp-title" type="text" class="w-full border-b py-2 font-bold outline-none bg-transparent" value="${node.title}">
                        </div>
                         <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Type</label>
                            <select id="insp-type" class="w-full mt-1 border p-2 rounded text-xs">
                                <option value="concept" ${node.type === 'concept' ? 'selected' : ''}>Concept</option>
                                <option value="profile" ${node.type === 'profile' ? 'selected' : ''}>Profile</option>
                                <option value="section" ${node.type === 'section' ? 'selected' : ''}>Web Section</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Content</label>
                            <textarea id="insp-content" class="w-full mt-1 border p-2 rounded text-sm h-32 outline-none">${node.content}</textarea>
                        </div>
                        <div class="flex gap-2 pt-4">
                            <button id="btn-child" class="flex-1 py-2 bg-slate-900 text-white rounded text-xs font-bold hover:bg-orange-600">Add Child</button>
                            <button id="btn-del" class="py-2 px-3 border text-red-500 rounded text-xs font-bold hover:bg-red-50">âœ•</button>
                        </div>
                    </div>
                `;

                // Bind Events
                document.getElementById('insp-title').oninput = (e) => MM.updateNode(node.id, { title: e.target.value });
                document.getElementById('insp-type').onchange = (e) => MM.updateNode(node.id, { type: e.target.value });
                document.getElementById('insp-content').oninput = (e) => MM.updateNode(node.id, { content: e.target.value });

                document.getElementById('btn-child').onclick = () => {
                    const cid = MM.addNode({ position: { x: node.position.x + 150, y: node.position.y + 50 } });
                    MM.addEdge(node.id, cid);
                    MM.autoLayout(); // Auto-arrange on add
                };

                document.getElementById('btn-del').onclick = () => MM.deleteNode(node.id);
            }
        };

        // Initialize on load
        UI.init();
    </script>
    <link rel="stylesheet" href="meta-mind-base.css">
    <link rel="stylesheet" href="meta-mind-ui.css">
    <style>
        /* CRITICAL EDGE FIX: SVG inside World Layer */
        #edge-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            overflow: visible;
            pointer-events: none;
            z-index: 10;
        }

        #world-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            will-change: transform;
            pointer-events: none;
        }

        .phase-view {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            inset: 0;
            background: white;
            z-index: 30;
        }

        .phase-view.active {
            display: block;
        }

        #view-map.active {
            background: transparent;
            z-index: 0;
        }
    </style>
    </body>

</html>