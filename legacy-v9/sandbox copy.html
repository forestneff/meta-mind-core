<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meta-Mind | Sandbox v8.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="meta-mind-base.css">
    <link rel="stylesheet" href="meta-mind-ui.css">
    <style>
        /* EDGE FIX: SVG inside World Layer with Overflow Visible */
        #edge-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            overflow: visible;
            pointer-events: none;
            z-index: 10;
        }

        .edge-vis {
            stroke: #94a3b8;
            stroke-width: 2px;
            fill: none;
            transition: stroke 0.2s;
            pointer-events: none;
            vector-effect: non-scaling-stroke;
        }

        .edge-vis.selected {
            stroke: var(--accent);
            stroke-width: 4px;
        }

        .edge-hit {
            stroke: transparent;
            stroke-width: 25px;
            fill: none;
            cursor: pointer;
            pointer-events: auto;
        }

        #world-layer {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            will-change: transform;
            pointer-events: none;
            width: 0;
            height: 0;
        }

        .node {
            z-index: 20;
            pointer-events: auto;
        }

        /* Phase Widget */
        .phase-widget {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            display: flex;
            gap: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            z-index: 40;
            pointer-events: auto;
        }

        .pw-btn {
            padding: 8px 16px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .pw-btn:hover {
            background: #f8fafc;
            color: #0f172a;
        }

        .pw-btn.active {
            background: #0f172a;
            color: white;
        }

        /* Overlays */
        #login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 420px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        /* Phase Views */
        .phase-view {
            position: absolute;
            inset: 0;
            background: white;
            z-index: 30;
            overflow-y: auto;
            display: none;
        }

        .phase-view.active {
            display: block;
        }

        /* Map is base layer */
        #view-map.active {
            display: block;
            z-index: 0;
            background: transparent;
        }
    </style>
</head>

<body>

    <!-- Login Overlay (Outside App Flow) -->
    <div id="login-overlay">
        <div class="login-card fade-in">
            <h2 class="text-3xl font-black mb-2 text-slate-900">Identity Init</h2>
            <p class="text-slate-500 mb-8 text-sm">Create your root profile node.</p>
            <form id="login-form" class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Display Name</label>
                    <input type="text" id="login-name"
                        class="w-full border border-slate-200 p-3 rounded-lg font-bold text-slate-800 outline-none"
                        required>
                </div>
                <button type="submit"
                    class="w-full py-3 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-orange-600 transition-colors shadow-lg uppercase tracking-widest">Initialize
                    System</button>
            </form>
        </div>
    </div>

    <div id="app" class="h-screen flex flex-col overflow-hidden">
        <!-- Header -->
        <header
            class="h-14 border-b border-slate-200 px-6 flex items-center justify-between shrink-0 bg-white z-50 relative">
            <span class="font-black text-xl">MM <span class="text-xs font-normal text-slate-400">Kernel
                    v4.1</span></span>
            <div class="flex gap-2">
                <button id="btn-reset" class="text-xs font-bold text-red-500 uppercase">Reset</button>
                <button id="btn-layout" class="text-xs font-bold text-slate-600 uppercase">Auto-Layout</button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden relative">
            <!-- Main Viewport -->
            <main id="viewport" class="flex-1 relative bg-slate-50 cursor-grab active:cursor-grabbing">

                <!-- Phase Widget -->
                <div class="phase-widget">
                    <div class="pw-btn active" data-phase="map">Map</div>
                    <div class="pw-btn" data-phase="text">Text</div>
                    <div class="pw-btn" data-phase="web">Web</div>
                </div>

                <!-- Phase 1: Map -->
                <div id="view-map" class="phase-view active">
                    <div id="world-layer">
                        <svg id="edge-svg"></svg>
                        <div id="node-layer"></div>

                        <!-- Radial Menu -->
                        <div id="radial-main" class="radial-wrapper">
                            <div class="radial-btn rad-n" onclick="UI.radialAction('add_child')" title="Add Detail">✚
                            </div>
                            <div class="radial-btn rad-e" onclick="UI.switchRadial('connect')" title="Connect">☍</div>
                            <div class="radial-btn rad-s" onclick="UI.radialAction('delete')" title="Delete">✕</div>
                            <div class="radial-btn rad-w" onclick="UI.radialAction('edit')" title="Edit">✎</div>
                        </div>

                        <!-- Connection Sub-Menu -->
                        <div id="radial-connect" class="radial-wrapper">
                            <div class="radial-btn rad-center" onclick="UI.switchRadial('main')" title="Back">BACK</div>
                            <div class="radial-btn rad-n" onclick="UI.startLinking('child')" title="Child">↓</div>
                            <div class="radial-btn rad-e" onclick="UI.startLinking('sibling')" title="Sibling">↔</div>
                            <div class="radial-btn rad-s" onclick="UI.startLinking('parent')" title="Parent">↑</div>
                            <div class="radial-btn rad-w" onclick="UI.startLinking('logic')" title="Logic">⚡</div>
                        </div>
                    </div>
                </div>

                <!-- Phase 2: Text -->
                <div id="view-text" class="phase-view p-8">
                    <div id="text-target" class="h-full"></div>
                </div>

                <!-- Phase 3: Web -->
                <div id="view-web" class="phase-view bg-slate-100 p-8">
                    <div id="web-target" class="max-w-4xl mx-auto space-y-4"></div>
                </div>

                <div id="linking-overlay"
                    class="absolute inset-0 bg-white/60 z-[60] hidden flex items-center justify-center pointer-events-none">
                    <div class="bg-orange-600 text-white px-4 py-2 rounded-full font-bold shadow-lg">Select Target Node
                    </div>
                </div>

                <div id="map-controls" class="absolute bottom-6 left-6 z-40 flex gap-2 pointer-events-auto">
                    <button onclick="MM.zoom(0.1)"
                        class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow font-bold text-slate-500">＋</button>
                    <button onclick="MM.zoom(-0.1)"
                        class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow font-bold text-slate-500">－</button>
                    <button onclick="MM.autoLayout()"
                        class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow font-bold text-slate-500">☍</button>
                </div>
            </main>

            <!-- Sidebar -->
            <aside class="w-80 bg-white border-l border-slate-200 flex flex-col z-50 shrink-0">
                <div class="p-4 border-b font-bold text-xs uppercase tracking-widest text-slate-400">Inspector</div>
                <div id="inspector-content" class="p-4 flex-1 overflow-y-auto">
                    <div class="text-center opacity-30 mt-10">Select a Node</div>
                </div>
                <div class="p-4 border-t bg-slate-50 space-y-2">
                    <button id="btn-portfolio"
                        class="w-full py-2 bg-orange-50 text-orange-600 rounded text-xs font-bold hover:bg-orange-100 uppercase tracking-widest border border-orange-200">Init
                        Portfolio</button>
                    <button onclick="MM.exportJSON()"
                        class="w-full py-2 bg-slate-900 text-white rounded text-xs font-bold hover:bg-slate-800 uppercase tracking-widest">Export</button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Use type="module" to load the local ES modules -->
    <script type="module">
        import { MetaMindKernel } from './meta-mind-core.js';
        import { TextPhaseEngine, WebPhaseEngine, PhaseRegistry } from './phase-engines.js';

        // Initialize Global Kernel
        window.MM = new MetaMindKernel();
        const Registry = new PhaseRegistry(window.MM);
        Registry.register(new TextPhaseEngine(window.MM));
        Registry.register(new WebPhaseEngine(window.MM));

        // --- UI CONTROLLER ---
        window.UI = {
            activePhase: 'map',
            isPanning: false,
            lastMouse: { x: 0, y: 0 },
            selectedEdgeId: null,
            radialContextId: null,
            activeLinkType: null,

            init() {
                // DOM Elements
                this.viewport = document.getElementById('viewport');
                this.world = document.getElementById('world-layer');
                this.svg = document.getElementById('edge-svg');
                this.nodeLayer = document.getElementById('node-layer');
                this.inspector = document.getElementById('inspector-content');

                // Bind Global Events
                this.bindEvents();

                // Initial Render
                if (MM.state.nodes.length > 0) {
                    document.getElementById('login-overlay').style.display = 'none';
                    this.render(MM.state);
                }

                // Subscribe to Kernel
                MM.subscribe((state, type) => this.render(state, type));
            },

            bindEvents() {
                // Login Form
                document.getElementById('login-form').onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('login-name').value;

                    // Create Root Profile
                    const root = MM.addNode({ title: name, type: 'profile', position: { x: 0, y: 0 }, content: 'Identity Root' });

                    MM.autoLayout();
                    document.getElementById('login-overlay').style.display = 'none';
                };

                // Portfolio Button
                document.getElementById('btn-portfolio').onclick = () => {
                    const root = MM.addNode({ title: "My Portfolio", position: { x: 0, y: 0 }, type: "section" });
                    const hero = MM.addNode({ title: "Hero", type: "hero", position: { x: -200, y: 150 } });
                    const proj = MM.addNode({ title: "Projects", type: "widget", position: { x: 200, y: 150 } });
                    MM.addEdge(root, hero);
                    MM.addEdge(root, proj);
                    MM.autoLayout();
                };

                // Phase Switching (Top Widget)
                document.querySelectorAll('.pw-btn').forEach(btn => {
                    btn.onclick = () => {
                        this.activePhase = btn.dataset.phase;
                        // Update buttons
                        document.querySelectorAll('.pw-btn').forEach(b => b.className = "pw-btn");
                        btn.className = "pw-btn active";

                        // Update Views Visibility
                        document.querySelectorAll('.phase-view').forEach(v => {
                            v.style.display = 'none';
                            v.classList.remove('active');
                        });
                        const targetView = document.getElementById(`view-${this.activePhase}`);
                        if (targetView) {
                            targetView.style.display = 'block';
                            targetView.classList.add('active');
                        }

                        // Trigger render
                        this.render(MM.state);
                    };
                });

                // Pan/Zoom
                this.viewport.onmousedown = (e) => {
                    if (e.target === this.viewport || e.target === this.svg || e.target.id === 'view-map') {
                        this.isPanning = true;
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                        this.deselectAll();
                    }
                };
                window.onmousemove = (e) => {
                    if (this.isPanning) {
                        MM.pan(e.clientX - this.lastMouse.x, e.clientY - this.lastMouse.y);
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    }
                };
                window.onmouseup = () => this.isPanning = false;
                this.viewport.onwheel = (e) => {
                    e.preventDefault();
                    MM.zoom(e.deltaY > 0 ? -0.1 : 0.1, e.clientX, e.clientY);
                };

                // Add Node
                this.viewport.ondblclick = (e) => {
                    if (this.activePhase === 'map') {
                        const pos = MM.screenToWorld(e.clientX, e.clientY);
                        const id = MM.addNode({ position: pos });
                        MM.state.selectedId = id;
                        MM.autoLayout();
                    }
                };

                // Toolbar
                document.getElementById('btn-reset').onclick = () => MM.resetStorage();
                document.getElementById('btn-layout').onclick = () => MM.autoLayout();
            },

            deselectAll() {
                MM.state.selectedId = null;
                this.selectedEdgeId = null;
                this.hideRadial();
                MM.notify();
            },

            selectEdge(id) {
                this.selectedEdgeId = id;
                MM.state.selectedId = null;
                this.hideRadial();
                MM.notify();
            },

            // --- Radial Logic ---
            showRadial(id, x, y, type = 'main') {
                document.querySelectorAll('.radial-wrapper').forEach(e => e.classList.remove('active'));
                const m = document.getElementById(`radial-${type}`);
                if (m) {
                    m.classList.add('active');
                    m.style.left = `${x}px`; m.style.top = `${y}px`;
                    m.style.transform = `translate(-50%, -50%) scale(${1 / MM.state.viewport.scale})`;
                    this.radialContextId = id;
                }
            },
            switchRadial(t) {
                if (this.radialContextId) {
                    const node = MM.state.nodes.find(n => n.id === this.radialContextId);
                    this.showRadial(this.radialContextId, node.position.x, node.position.y, t);
                }
            },
            hideRadial() { document.querySelectorAll('.radial-wrapper').forEach(e => e.classList.remove('active')); this.radialContextId = null; },

            radialAction(act) {
                if (!this.radialContextId) return;
                const id = this.radialContextId;
                const node = MM.state.nodes.find(n => n.id === id);
                if (act === 'delete') MM.deleteNode(id);
                if (act === 'add_child') {
                    const cid = MM.addNode({ position: { x: node.position.x + 150, y: node.position.y + 50 } });
                    MM.addEdge(id, cid);
                    MM.autoLayout();
                }
                if (act === 'edit') { document.getElementById('inp-title')?.focus(); }
                this.hideRadial();
            },

            startLinking(t) { this.activeLinkType = t; this.hideRadial(); document.getElementById('linking-overlay').style.display = 'flex'; document.getElementById('viewport').style.cursor = 'crosshair'; },
            completeLinking(tgt) { if (this.radialContextId && tgt !== this.radialContextId) MM.addEdge(this.radialContextId, tgt, this.activeLinkType); this.cancelLinking(); },
            cancelLinking() { this.activeLinkType = null; document.getElementById('linking-overlay').style.display = 'none'; document.getElementById('viewport').style.cursor = 'grab'; },

            getIcon(type) {
                const bp = MM.getBlueprint(type);
                return bp ? bp.icon : '⚪';
            },

            render(state, type) {
                if (this.activePhase === 'map') {
                    this.renderMap(state);
                } else {
                    Registry.activeId = this.activePhase;
                    let targetId = this.activePhase === 'web' ? 'web-target' : 'text-target';
                    Registry.renderActive(targetId);
                }
                this.renderInspector(state);
            },

            renderMap(state) {
                // Apply Transform
                this.world.style.transform = `translate(${state.viewport.x}px, ${state.viewport.y}px) scale(${state.viewport.scale})`;

                // Render Nodes
                this.nodeLayer.innerHTML = '';
                state.nodes.forEach(n => {
                    const el = document.createElement('div');
                    el.className = `absolute w-16 h-16 bg-white border-2 rounded-full flex flex-col items-center justify-center transition-all duration-200 shadow-sm cursor-pointer z-20 hover:border-orange-400 ${state.selectedId === n.id ? 'border-orange-500 shadow-md scale-110' : 'border-slate-300'}`;
                    el.style.left = `${n.position.x}px`;
                    el.style.top = `${n.position.y}px`;
                    el.style.transform = 'translate(-50%, -50%)';
                    el.onclick = (e) => {
                        e.stopPropagation();
                        if (this.activeLinkType) { this.completeLinking(n.id); return; }
                        MM.state.selectedId = n.id;
                        this.selectedEdgeId = null;
                        this.showRadial(n.id, n.position.x, n.position.y);
                        MM.notify();
                    };

                    let icon = this.getIcon(n.type);
                    el.innerHTML = `<div class="text-xl pointer-events-none">${icon}</div><div class="text-[8px] font-bold uppercase text-slate-500 pointer-events-none truncate max-w-full px-1">${n.title}</div>`;
                    this.nodeLayer.appendChild(el);
                });

                // Render Edges (Using local coords because SVG is inside transformed world)
                this.svg.innerHTML = '';
                state.edges.forEach(e => {
                    const s = state.nodes.find(n => n.id === e.source);
                    const t = state.nodes.find(n => n.id === e.target);
                    if (s && t) {
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        line.setAttribute("x1", s.position.x);
                        line.setAttribute("y1", s.position.y);
                        line.setAttribute("x2", t.position.x);
                        line.setAttribute("y2", t.position.y);
                        line.setAttribute("class", `edge-vis ${this.selectedEdgeId === e.id ? 'selected' : ''}`);
                        this.svg.appendChild(line);

                        const hit = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        hit.setAttribute("x1", s.position.x); hit.setAttribute("y1", s.position.y);
                        hit.setAttribute("x2", t.position.x); hit.setAttribute("y2", t.position.y);
                        hit.setAttribute("class", "edge-hit");
                        hit.onclick = (ev) => { ev.stopPropagation(); this.selectEdge(e.id); };
                        this.svg.appendChild(hit);
                    }
                });
            },

            renderInspector(state) {
                const container = document.getElementById('inspector-content');
                if (this.selectedEdgeId) {
                    const edge = state.edges.find(e => e.id === this.selectedEdgeId);
                    if (!edge) return;
                    container.innerHTML = `<div class="space-y-6 animate-fade-in"><div class="text-xs font-bold text-orange-600 uppercase tracking-widest mb-4">⚡ Connection</div><section><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Weight</label><input type="number" id="inp-weight" value="${edge.meta?.weight || 1.0}" class="w-full border-b border-slate-200 py-2 font-bold"></section><button onclick="MM.deleteEdge('${edge.id}')" class="w-full py-2 bg-red-50 text-red-600 rounded text-xs font-bold mt-4">Delete Connection</button></div>`;
                    return;
                }
                const node = state.nodes.find(n => n.id === state.selectedId);
                if (!node) {
                    if (!container.querySelector('.opacity-30')) container.innerHTML = `<div class="h-full flex flex-col items-center justify-center opacity-30 mt-20"><div class="text-4xl mb-2">⦿</div><p class="text-xs font-bold uppercase tracking-widest">Select Node</p></div>`;
                    return;
                }
                if (container.dataset.renderedId === node.id && !this.selectedEdgeId) return;
                container.dataset.renderedId = node.id;

                container.innerHTML = `
                    <div class="space-y-6 animate-fade-in">
                        <section><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Label</label><input type="text" id="inp-title" value="${node.title}" class="w-full border-b border-slate-200 py-2 font-bold text-xl focus:outline-none focus:border-orange-500 bg-transparent transition-colors"></section>
                        <section><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Type</label><select id="inp-type" class="w-full mt-1 bg-white border border-slate-200 text-xs p-2 rounded"><option value="section" ${node.type === 'section' ? 'selected' : ''}>Section</option><option value="hero" ${node.type === 'hero' ? 'selected' : ''}>Hero</option><option value="button" ${node.type === 'button' ? 'selected' : ''}>Button</option><option value="nav" ${node.type === 'nav' ? 'selected' : ''}>Navbar</option><option value="widget" ${node.type === 'widget' ? 'selected' : ''}>Widget</option><option value="profile" ${node.type === 'profile' ? 'selected' : ''}>Profile</option></select></section>
                        <section><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Renderer</label><select id="inp-renderer" class="w-full mt-1 bg-white border border-slate-200 text-xs p-2 rounded"><option value="text">Text Outline</option><option value="web">Web Architect</option></select></section>
                        <section><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Content</label><textarea id="inp-content" class="w-full mt-2 bg-white border border-slate-100 p-4 rounded-xl text-sm min-h-[120px] focus:outline-none focus:border-slate-300 transition-colors">${node.content}</textarea></section>
                    </div>`;
                document.getElementById('inp-title').onchange = (e) => MM.updateNode(node.id, { title: e.target.value });
                document.getElementById('inp-type').onchange = (e) => MM.updateNode(node.id, { type: e.target.value });
                document.getElementById('inp-renderer').onchange = (e) => { if (!node.metadata) node.metadata = {}; node.metadata.renderer = e.target.value; MM.updateNode(node.id, { metadata: node.metadata }); };
                document.getElementById('inp-content').onblur = (e) => MM.updateNode(node.id, { content: e.target.value });
            },

            async triggerSense() { if (!MM.state.selectedId) return; const res = await MM.senseIntent("Contextual Expansion"); alert(`AI SUGGESTION:\n${res.content}`); }
        };

        MM.deleteEdge = (id) => {
            MM.state.edges = MM.state.edges.filter(e => e.id !== id);
            MM.selectedId = null;
            UI.selectedEdgeId = null;
            MM.saveHistory();
            MM.notify();
        };

        // EXPOSE UI FOR DEBUG
        window.UI = UI;

        UI.init();
    </script>
</body>

</html>